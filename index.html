<!DOCTYPE html>
<html lang="id">
<head>
   <meta charset="UTF-8">
   <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
   <title>SouGPT</title>
   <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
   <style>
       * {
           margin: 0;
           padding: 0;
           box-sizing: border-box;
       }

       :root {
           --bg-primary: #000000;
           --bg-secondary: #171717;
           --bg-tertiary: #212121;
           --bg-input: #2a2a2a;
           --bg-reasoning: #0a0a0a;
           --text-primary: #ffffff;
           --text-secondary: #b4b4b4;
           --text-tertiary: #6e6e6e;
           --border: #2f2f2f;
           --border-light: #424242;
           --accent: #10a37f;
           --accent-hover: #1a7f64;
           --error: #ef4146;
       }

       [data-theme="light"] {
           --bg-primary: #ffffff;
           --bg-secondary: #f7f7f8;
           --bg-tertiary: #ececf1;
           --bg-input: #f7f7f8;
           --bg-reasoning: #f0f0f0;
           --text-primary: #343541;
           --text-secondary: #6e6e80;
           --text-tertiary: #acacbe;
           --border: #d9d9e3;
           --border-light: #c5c5d2;
       }

       html, body {
           height: 100%;
           font-family: "Söhne", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
           background: var(--bg-primary);
           color: var(--text-primary);
           overflow: hidden;
       }

       .hidden {
           display: none !important;
       }

       .intro-screen {
           position: fixed;
           top: 0;
           left: 0;
           right: 0;
           bottom: 0;
           background: var(--bg-primary);
           display: flex;
           flex-direction: column;
           align-items: center;
           justify-content: center;
           z-index: 1000;
           transition: opacity 0.8s ease, visibility 0.8s ease;
       }

       .intro-screen.fade-out {
           opacity: 0;
           visibility: hidden;
       }

       .intro-content {
           text-align: center;
           padding: 40px;
       }

       .intro-logo {
           font-size: 72px;
           font-weight: 700;
           letter-spacing: -2px;
           margin-bottom: 24px;
           display: flex;
           align-items: center;
           justify-content: center;
           gap: 4px;
       }

       .intro-text {
           display: inline-block;
       }

       .intro-cursor {
           width: 4px;
           height: 72px;
           background: var(--text-primary);
           animation: blink 1s infinite;
           display: inline-block;
           margin-left: 4px;
       }

       @keyframes blink {
           0%, 50% { opacity: 1; }
           51%, 100% { opacity: 0; }
       }

       .intro-tagline {
           font-size: 18px;
           color: var(--text-secondary);
           font-weight: 400;
           opacity: 0;
           transform: translateY(20px);
           transition: all 0.6s ease;
       }

       .intro-tagline.show {
           opacity: 1;
           transform: translateY(0);
       }

       .intro-dots {
           display: inline-flex;
           gap: 4px;
           margin-left: 8px;
       }

       .intro-dot {
           width: 6px;
           height: 6px;
           background: var(--text-primary);
           border-radius: 50%;
           animation: introPulse 1.4s infinite ease-in-out both;
       }

       .intro-dot:nth-child(1) { animation-delay: -0.32s; }
       .intro-dot:nth-child(2) { animation-delay: -0.16s; }
       .intro-dot:nth-child(3) { animation-delay: 0s; }

       @keyframes introPulse {
           0%, 80%, 100% { transform: scale(0.6); opacity: 0.4; }
           40% { transform: scale(1); opacity: 1; }
       }

       .login-page {
           position: fixed;
           top: 0;
           left: 0;
           right: 0;
           bottom: 0;
           background: var(--bg-primary);
           display: flex;
           align-items: center;
           justify-content: center;
           padding: 20px;
           z-index: 100;
           opacity: 0;
           visibility: hidden;
           transition: all 0.4s ease;
       }

       .login-page.active {
           opacity: 1;
           visibility: visible;
       }

       .login-card {
           background: var(--bg-secondary);
           border: 1px solid var(--border);
           border-radius: 8px;
           padding: 40px;
           width: 100%;
           max-width: 400px;
       }

       .login-header {
           text-align: center;
           margin-bottom: 32px;
       }

       .login-logo-small {
           font-size: 32px;
           font-weight: 700;
           margin-bottom: 8px;
       }

       .login-subtitle {
           color: var(--text-secondary);
           font-size: 14px;
       }

       .form-group {
           margin-bottom: 20px;
       }

       .form-label {
           display: block;
           font-size: 14px;
           color: var(--text-secondary);
           margin-bottom: 8px;
           font-weight: 500;
       }

       .form-input {
           width: 100%;
           background: var(--bg-primary);
           border: 1px solid var(--border);
           border-radius: 6px;
           padding: 12px 14px;
           color: var(--text-primary);
           font-size: 15px;
           transition: all 0.2s;
           outline: none;
       }

       .form-input:focus {
           border-color: var(--accent);
       }

       .form-input::placeholder {
           color: var(--text-tertiary);
       }

       .login-btn {
           width: 100%;
           background: var(--accent);
           color: white;
           border: none;
           border-radius: 6px;
           padding: 12px;
           font-size: 15px;
           font-weight: 500;
           cursor: pointer;
           transition: all 0.2s;
           display: flex;
           align-items: center;
           justify-content: center;
           gap: 8px;
           margin-top: 8px;
       }

       .login-btn:hover:not(:disabled) {
           background: var(--accent-hover);
       }

       .login-btn:disabled {
           opacity: 0.6;
           cursor: not-allowed;
       }

       .error-message {
           background: rgba(239, 65, 70, 0.1);
           border: 1px solid rgba(239, 65, 70, 0.3);
           color: var(--error);
           padding: 12px;
           border-radius: 6px;
           font-size: 14px;
           margin-top: 16px;
           display: none;
       }

       .error-message.show {
           display: block;
       }

       .loading-spinner {
           width: 16px;
           height: 16px;
           border: 2px solid transparent;
           border-top-color: white;
           border-radius: 50%;
           animation: spin 0.8s linear infinite;
       }

       @keyframes spin {
           to { transform: rotate(360deg); }
       }

       .app {
           display: flex;
           flex-direction: column;
           height: 100vh;
           max-width: 900px;
           margin: 0 auto;
           position: relative;
           opacity: 0;
           visibility: hidden;
           transition: all 0.4s ease;
       }

       .app.active {
           opacity: 1;
           visibility: visible;
       }

       .header {
           display: flex;
           justify-content: space-between;
           align-items: center;
           padding: 12px 16px;
           border-bottom: 1px solid var(--border);
           background: var(--bg-primary);
           flex-shrink: 0;
           min-height: 52px;
       }

       .header-left {
           display: flex;
           align-items: center;
           gap: 12px;
       }

       .logo {
           font-size: 18px;
           font-weight: 600;
       }

       .model-selector {
           display: flex;
           align-items: center;
           gap: 6px;
           color: var(--text-secondary);
           font-size: 14px;
           cursor: pointer;
           padding: 4px 8px;
           border-radius: 4px;
           transition: all 0.2s;
       }

       .model-selector:hover {
           background: var(--bg-secondary);
           color: var(--text-primary);
       }

       .header-actions {
           display: flex;
           gap: 8px;
           align-items: center;
       }

       .btn-icon {
           background: transparent;
           border: none;
           color: var(--text-secondary);
           width: 36px;
           height: 36px;
           border-radius: 6px;
           cursor: pointer;
           display: flex;
           align-items: center;
           justify-content: center;
           transition: all 0.2s;
       }

       .btn-icon:hover {
           background: var(--bg-secondary);
           color: var(--text-primary);
       }

       .btn-text {
           background: transparent;
           border: none;
           color: var(--text-secondary);
           padding: 8px 12px;
           border-radius: 6px;
           font-size: 13px;
           cursor: pointer;
           transition: all 0.2s;
           display: flex;
           align-items: center;
           gap: 6px;
       }

       .btn-text:hover {
           background: var(--bg-secondary);
           color: var(--text-primary);
       }

       .user-menu {
           position: relative;
       }

       .user-avatar {
           width: 32px;
           height: 32px;
           background: var(--accent);
           border-radius: 4px;
           display: flex;
           align-items: center;
           justify-content: center;
           font-size: 12px;
           font-weight: 600;
           color: white;
           cursor: pointer;
       }

       .dropdown {
           position: absolute;
           top: 44px;
           right: 0;
           background: var(--bg-secondary);
           border: 1px solid var(--border);
           border-radius: 8px;
           padding: 4px;
           min-width: 200px;
           opacity: 0;
           visibility: hidden;
           transform: translateY(-10px);
           transition: all 0.2s;
           z-index: 50;
       }

       .dropdown.show {
           opacity: 1;
           visibility: visible;
           transform: translateY(0);
       }

       .dropdown-item {
           padding: 10px 12px;
           border-radius: 6px;
           cursor: pointer;
           font-size: 13px;
           color: var(--text-primary);
           display: flex;
           align-items: center;
           gap: 8px;
           transition: all 0.2s;
       }

       .dropdown-item:hover {
           background: var(--bg-tertiary);
       }

       .dropdown-divider {
           height: 1px;
           background: var(--border);
           margin: 4px 0;
       }

       .dropdown-item.danger {
           color: var(--error);
       }

       .chat-wrapper {
           flex: 1;
           overflow-y: auto;
           overflow-x: hidden;
           position: relative;
       }

       .landing {
           display: flex;
           flex-direction: column;
           align-items: center;
           justify-content: center;
           min-height: 100%;
           padding: 40px 20px;
           text-align: center;
       }

       .landing-title {
           font-size: 32px;
           font-weight: 600;
           margin-bottom: 40px;
           color: var(--text-primary);
       }

       .suggestions {
           display: grid;
           grid-template-columns: repeat(2, 1fr);
           gap: 12px;
           width: 100%;
           max-width: 600px;
       }

       .suggestion-item {
           background: var(--bg-secondary);
           border: 1px solid var(--border);
           padding: 16px;
           border-radius: 8px;
           cursor: pointer;
           text-align: left;
           font-size: 14px;
           color: var(--text-secondary);
           transition: all 0.2s;
           line-height: 1.5;
       }

       .suggestion-item:hover {
           border-color: var(--border-light);
           color: var(--text-primary);
           background: var(--bg-tertiary);
       }

       .messages {
           display: none;
           flex-direction: column;
           padding-bottom: 140px;
       }

       .messages.active {
           display: flex;
       }

       .message-row {
           display: flex;
           padding: 20px;
           animation: slideUp 0.3s ease;
       }

       .message-row.user {
           justify-content: flex-end;
           background: var(--bg-secondary);
       }

       .message-row.ai {
           justify-content: flex-start;
           background: var(--bg-primary);
       }

       @keyframes slideUp {
           from { opacity: 0; transform: translateY(8px); }
           to { opacity: 1; transform: translateY(0); }
       }

       .user-bubble {
           background: var(--bg-tertiary);
           border: 1px solid var(--border);
           border-radius: 18px;
           padding: 10px 16px;
           max-width: 80%;
           position: relative;
           cursor: pointer;
           transition: all 0.2s;
       }

       .user-bubble:hover {
           border-color: var(--border-light);
       }

       .user-bubble .message-content {
           font-size: 15px;
           line-height: 1.5;
           color: var(--text-primary);
       }

       .copy-popup {
           position: absolute;
           top: -40px;
           left: 50%;
           transform: translateX(-50%);
           background: var(--bg-tertiary);
           border: 1px solid var(--border);
           border-radius: 6px;
           padding: 8px 12px;
           font-size: 13px;
           color: var(--text-primary);
           opacity: 0;
           visibility: hidden;
           transition: all 0.2s;
           display: flex;
           align-items: center;
           gap: 6px;
           white-space: nowrap;
           z-index: 10;
       }

       .user-bubble.show-popup .copy-popup {
           opacity: 1;
           visibility: visible;
       }

       .ai-content {
           max-width: 85%;
           width: 100%;
       }

       .message-content {
           line-height: 1.7;
           font-size: 16px;
           color: var(--text-primary);
       }

       .message-content.font-small { font-size: 14px; }
       .message-content.font-medium { font-size: 16px; }
       .message-content.font-large { font-size: 18px; }

       .message-content p {
           margin-bottom: 12px;
       }

       .message-content p:last-child {
           margin-bottom: 0;
       }

       .message-content h1,
       .message-content h2,
       .message-content h3 {
           margin: 24px 0 16px;
           font-weight: 600;
           color: var(--text-primary);
       }

       .message-content h1 { font-size: 20px; }
       .message-content h2 { font-size: 18px; }
       .message-content h3 { font-size: 16px; }

       .message-content ul,
       .message-content ol {
           margin: 12px 0;
           padding-left: 24px;
       }

       .message-content li {
           margin-bottom: 8px;
       }

       .message-content code {
           background: var(--bg-tertiary);
           padding: 2px 6px;
           border-radius: 4px;
           font-family: "SF Mono", Monaco, monospace;
           font-size: 14px;
           color: var(--text-primary);
       }

       .message-content pre {
           background: var(--bg-tertiary);
           padding: 16px;
           border-radius: 6px;
           overflow-x: auto;
           margin: 16px 0;
           border: 1px solid var(--border);
       }

       .message-content pre code {
           background: none;
           padding: 0;
           font-size: 14px;
           line-height: 1.6;
       }

       .message-content blockquote {
           border-left: 3px solid var(--text-tertiary);
           padding-left: 16px;
           margin: 16px 0;
           color: var(--text-secondary);
       }

       .message-content strong {
           font-weight: 600;
           color: var(--text-primary);
       }

       .message-content hr {
           border: none;
           border-top: 1px solid var(--border);
           margin: 24px 0;
       }

       .thinking-box {
           margin-bottom: 12px;
           border: 1px solid var(--border);
           border-radius: 8px;
           overflow: hidden;
           transition: all 0.3s ease;
       }

       .thinking-box.thinking-done {
           opacity: 0.7;
       }

       .thinking-toggle {
           width: 100%;
           background: var(--bg-secondary);
           border: none;
           padding: 10px 14px;
           cursor: pointer;
           display: flex;
           align-items: center;
           gap: 8px;
           color: var(--text-secondary);
           font-size: 13px;
           transition: all 0.2s;
           font-family: inherit;
       }

       .thinking-toggle:hover {
           background: var(--bg-tertiary);
           color: var(--text-primary);
       }

       .thinking-toggle svg {
           transition: transform 0.3s ease;
       }

       .thinking-toggle.expanded svg {
           transform: rotate(90deg);
       }

       .thinking-status {
           margin-left: auto;
           font-size: 12px;
           color: var(--text-tertiary);
           font-style: italic;
           display: flex;
           align-items: center;
           gap: 6px;
       }

       .thinking-content {
           background: var(--bg-reasoning);
           padding: 0 14px;
           font-size: 13px;
           line-height: 1.7;
           color: var(--text-secondary);
           white-space: pre-wrap;
           max-height: 0;
           overflow: hidden;
           transition: max-height 0.3s ease, padding 0.3s ease;
       }

       .thinking-content.expanded {
           max-height: 500px;
           padding: 14px;
           overflow-y: auto;
       }

       .thinking-done .thinking-status {
           color: var(--text-tertiary);
           font-style: normal;
       }

       .response-section {
           transition: all 0.3s ease;
       }

       .response-section.hidden {
           display: none;
       }

       .typing-indicator {
           display: inline-flex;
           align-items: center;
           margin-left: 4px;
           gap: 3px;
       }

       .typing-dot {
           width: 5px;
           height: 5px;
           background: var(--text-secondary);
           border-radius: 50%;
           animation: typingPulse 1.4s infinite ease-in-out both;
       }

       .typing-dot:nth-child(1) { animation-delay: -0.32s; }
       .typing-dot:nth-child(2) { animation-delay: -0.16s; }
       .typing-dot:nth-child(3) { animation-delay: 0s; }

       @keyframes typingPulse {
           0%, 80%, 100% { transform: scale(0.6); opacity: 0.4; }
           40% { transform: scale(1); opacity: 1; }
       }

       .input-container {
           position: fixed;
           bottom: 0;
           left: 0;
           right: 0;
           padding: 12px 16px 24px;
           background: linear-gradient(to top, var(--bg-primary) 60%, transparent);
           z-index: 40;
       }

       .input-wrapper {
           display: flex;
           gap: 12px;
           align-items: flex-end;
           background: var(--bg-input);
           border: 1px solid var(--border);
           border-radius: 12px;
           padding: 12px 16px;
           transition: all 0.2s;
           max-width: 768px;
           margin: 0 auto;
           box-shadow: 0 0 20px rgba(0,0,0,0.5);
       }

       .input-wrapper:focus-within {
           border-color: var(--border-light);
       }

       .chat-input {
           flex: 1;
           background: transparent;
           border: none;
           color: var(--text-primary);
           font-size: 16px;
           line-height: 1.5;
           resize: none;
           max-height: 200px;
           min-height: 24px;
           font-family: inherit;
           outline: none;
       }

       .chat-input::placeholder {
           color: var(--text-tertiary);
       }

       .btn-send {
           background: var(--text-secondary);
           color: var(--bg-primary);
           border: none;
           width: 32px;
           height: 32px;
           border-radius: 6px;
           cursor: pointer;
           display: flex;
           align-items: center;
           justify-content: center;
           transition: all 0.2s;
           flex-shrink: 0;
       }

       .btn-send:hover:not(:disabled) {
           background: var(--text-primary);
       }

       .btn-send:disabled {
           opacity: 0.3;
           cursor: not-allowed;
       }

       .btn-stop {
           background: #ef4146;
           color: white;
           border: none;
           width: 32px;
           height: 32px;
           border-radius: 6px;
           cursor: pointer;
           display: flex;
           align-items: center;
           justify-content: center;
           transition: all 0.2s;
           flex-shrink: 0;
           animation: pulseRed 1.5s ease-in-out infinite;
       }

       @keyframes pulseRed {
           0%, 100% { box-shadow: 0 0 0 0 rgba(239, 65, 70, 0.7); }
           50% { box-shadow: 0 0 0 8px rgba(239, 65, 70, 0); }
       }

       .btn-stop:hover {
           background: #dc2626;
       }

       .loading-container {
           display: none;
           padding: 32px;
           justify-content: center;
           align-items: center;
           gap: 12px;
           color: var(--text-secondary);
           font-size: 14px;
       }

       .loading-container.active {
           display: flex;
       }

       .loading-status {
           font-style: italic;
       }

       .history-panel {
           position: fixed;
           top: 0;
           right: -360px;
           width: 360px;
           height: 100vh;
           background: var(--bg-secondary);
           border-left: 1px solid var(--border);
           z-index: 100;
           transition: right 0.3s ease;
           display: flex;
           flex-direction: column;
       }

       .history-panel.open {
           right: 0;
       }

       .history-header {
           padding: 16px;
           border-bottom: 1px solid var(--border);
           display: flex;
           justify-content: space-between;
           align-items: center;
       }

       .history-title {
           font-size: 16px;
           font-weight: 600;
       }

       .history-actions {
           display: flex;
           gap: 8px;
       }

       .history-search {
           padding: 8px;
           border-bottom: 1px solid var(--border);
       }

       .history-search-wrapper {
           position: relative;
       }

       .history-search-input {
           width: 100%;
           background: var(--bg-primary);
           border: 1px solid var(--border);
           border-radius: 6px;
           padding: 8px 32px 8px 12px;
           color: var(--text-primary);
           font-size: 13px;
           outline: none;
       }

       .history-search-input:focus {
           border-color: var(--border-light);
       }

       .history-search-clear {
           position: absolute;
           right: 8px;
           top: 50%;
           transform: translateY(-50%);
           background: none;
           border: none;
           color: var(--text-tertiary);
           cursor: pointer;
           font-size: 16px;
           display: none;
       }

       .history-search-clear.show {
           display: block;
       }

       .history-list {
           flex: 1;
           overflow-y: auto;
           padding: 8px;
       }

       .empty-history {
           text-align: center;
           padding: 40px 20px;
           color: var(--text-tertiary);
           font-size: 14px;
       }

       .no-results {
           text-align: center;
           padding: 40px 20px;
           color: var(--text-tertiary);
           font-size: 14px;
       }

       .history-item {
           padding: 12px;
           border-radius: 6px;
           cursor: pointer;
           margin-bottom: 4px;
           display: flex;
           justify-content: space-between;
           align-items: center;
           transition: all 0.2s;
       }

       .history-item:hover {
           background: var(--bg-tertiary);
       }

       .history-item.active {
           background: var(--bg-tertiary);
       }

       .history-item.pinned {
           border-left: 3px solid var(--accent);
       }

       .history-text {
           flex: 1;
           overflow: hidden;
           margin-right: 8px;
       }

       .history-preview {
           font-size: 14px;
           white-space: nowrap;
           overflow: hidden;
           text-overflow: ellipsis;
           color: var(--text-primary);
           margin-bottom: 4px;
       }

       .history-time {
           font-size: 12px;
           color: var(--text-tertiary);
       }

       .history-actions-item {
           display: flex;
           gap: 4px;
       }

       .history-pin {
           background: none;
           border: none;
           color: var(--text-tertiary);
           cursor: pointer;
           padding: 6px;
           border-radius: 4px;
           opacity: 0;
           transition: all 0.2s;
       }

       .history-item:hover .history-pin {
           opacity: 1;
       }

       .history-pin:hover {
           color: var(--accent);
           background: rgba(16, 163, 127, 0.1);
       }

       .history-pin.pinned {
           opacity: 1;
           color: var(--accent);
       }

       .history-delete {
           background: none;
           border: none;
           color: var(--text-tertiary);
           cursor: pointer;
           padding: 6px;
           border-radius: 4px;
           opacity: 0;
           transition: all 0.2s;
       }

       .history-item:hover .history-delete {
           opacity: 1;
       }

       .history-delete:hover {
           color: var(--error);
           background: rgba(239, 65, 70, 0.1);
       }

       .overlay {
           position: fixed;
           top: 0;
           left: 0;
           right: 0;
           bottom: 0;
           background: rgba(0, 0, 0, 0.6);
           backdrop-filter: blur(4px);
           z-index: 99;
           opacity: 0;
           visibility: hidden;
           transition: all 0.3s;
       }

       .overlay.active {
           opacity: 1;
           visibility: visible;
       }

       .settings-panel {
           position: fixed;
           top: 0;
           left: -320px;
           width: 320px;
           height: 100vh;
           background: var(--bg-secondary);
           border-right: 1px solid var(--border);
           z-index: 100;
           transition: left 0.3s ease;
           display: flex;
           flex-direction: column;
       }

       .settings-panel.open {
           left: 0;
       }

       .settings-header {
           padding: 16px;
           border-bottom: 1px solid var(--border);
           display: flex;
           justify-content: space-between;
           align-items: center;
       }

       .settings-title {
           font-size: 16px;
           font-weight: 600;
       }

       .settings-content {
           flex: 1;
           overflow-y: auto;
           padding: 16px;
       }

       .settings-section {
           margin-bottom: 24px;
       }

       .settings-section-title {
           font-size: 13px;
           font-weight: 600;
           color: var(--text-secondary);
           text-transform: uppercase;
           margin-bottom: 12px;
           letter-spacing: 0.5px;
       }

       .settings-option {
           margin-bottom: 12px;
       }

       .settings-label {
           display: block;
           font-size: 14px;
           color: var(--text-primary);
           margin-bottom: 8px;
       }

       .settings-radio-group {
           display: flex;
           flex-direction: column;
           gap: 8px;
       }

       .settings-radio {
           display: flex;
           align-items: center;
           gap: 8px;
           cursor: pointer;
           padding: 8px;
           border-radius: 6px;
           transition: background 0.2s;
       }

       .settings-radio:hover {
           background: var(--bg-tertiary);
       }

       .settings-radio input {
           cursor: pointer;
       }

       .settings-radio span {
           font-size: 14px;
           color: var(--text-secondary);
       }

       .settings-radio input:checked + span {
           color: var(--text-primary);
       }

       .settings-info {
           background: var(--bg-tertiary);
           padding: 12px;
           border-radius: 6px;
           margin-top: 8px;
       }

       .settings-info-row {
           display: flex;
           justify-content: space-between;
           margin-bottom: 8px;
           font-size: 13px;
       }

       .settings-info-row:last-child {
           margin-bottom: 0;
       }

       .settings-info-label {
           color: var(--text-secondary);
       }

       .settings-info-value {
           color: var(--text-primary);
           font-weight: 500;
       }

       .code-block-wrapper {
           margin: 16px 0;
           border-radius: 8px;
           overflow: hidden;
           border: 1px solid var(--border);
       }

       .code-block-header {
           display: flex;
           justify-content: space-between;
           align-items: center;
           background: var(--bg-secondary);
           padding: 8px 14px;
           border-bottom: 1px solid var(--border);
       }

       .code-block-lang {
           font-size: 12px;
           color: var(--text-secondary);
           font-family: "SF Mono", Monaco, monospace;
           text-transform: lowercase;
       }

       .code-block-copy {
           background: none;
           border: none;
           color: var(--text-secondary);
           cursor: pointer;
           padding: 4px 8px;
           border-radius: 4px;
           font-size: 12px;
           display: flex;
           align-items: center;
           gap: 6px;
           transition: all 0.2s;
       }

       .code-block-copy:hover {
           background: var(--bg-input);
           color: var(--text-primary);
       }

       .code-block-copy.copied {
           color: var(--accent);
       }

       .code-block-wrapper pre {
           margin: 0;
           border-radius: 0;
           border: none;
           background: var(--bg-tertiary);
       }

       .custom-notif {
           position: fixed;
           bottom: 90px;
           left: 50%;
           transform: translateX(-50%) translateY(20px);
           padding: 12px 20px;
           border-radius: 8px;
           color: white;
           font-size: 14px;
           font-weight: 500;
           opacity: 0;
           transition: all 0.3s ease;
           z-index: 9999;
           white-space: nowrap;
           box-shadow: 0 4px 12px rgba(0,0,0,0.3);
           pointer-events: none;
       }

       .custom-notif.show {
           opacity: 1;
           transform: translateX(-50%) translateY(0);
       }

       .stopped-indicator {
           font-size: 13px;
           color: var(--text-secondary);
           font-style: italic;
           margin-top: 8px;
           display: flex;
           align-items: center;
           gap: 6px;
       }

       @media print {
           body {
               background: white !important;
               color: black !important;
           }
           
           .header,
           .input-container,
           .history-panel,
           .settings-panel,
           .overlay,
           .btn-icon,
           .btn-text,
           .user-menu,
           .intro-screen,
           .login-page,
           .custom-notif {
               display: none !important;
           }
           
           .app {
               opacity: 1 !important;
               visibility: visible !important;
               max-width: 100% !important;
           }
           
           .chat-wrapper {
               overflow: visible !important;
           }
           
           .messages {
               display: flex !important;
               padding-bottom: 0 !important;
           }
           
           .message-row {
               break-inside: avoid;
               background: white !important;
               color: black !important;
           }
           
           .message-row.user {
               background: #f0f0f0 !important;
           }
           
           .ai-content {
               max-width: 100% !important;
           }
           
           .thinking-box,
           .btn-reasoning,
           .thinking-toggle {
               display: none !important;
           }
       }

       @media (max-width: 768px) {
           .intro-logo {
               font-size: 48px;
           }

           .intro-cursor {
               height: 48px;
           }

           .landing-title {
               font-size: 24px;
           }

           .suggestions {
               grid-template-columns: 1fr;
           }

           .user-bubble {
               max-width: 85%;
           }

           .ai-content {
               max-width: 100%;
           }

           .history-panel,
           .settings-panel {
               width: 100%;
               right: -100%;
               left: auto;
           }

           .settings-panel {
               left: -100%;
               right: auto;
           }

           .settings-panel.open {
               left: 0;
           }
       }

       ::-webkit-scrollbar {
           width: 8px;
           height: 8px;
       }

       ::-webkit-scrollbar-track {
           background: transparent;
       }

       ::-webkit-scrollbar-thumb {
           background: var(--border);
           border-radius: 4px;
       }

       ::-webkit-scrollbar-thumb:hover {
           background: var(--border-light);
       }
   </style>
</head>
<body>
   <div class="custom-notif" id="customNotif"></div>

   <div class="intro-screen" id="introScreen">
       <div class="intro-content">
           <div class="intro-logo">
               <span class="intro-text" id="introText"></span>
               <span class="intro-cursor" id="introCursor"></span>
               <span class="intro-dots" id="introDots" style="display: none;">
                   <span class="intro-dot"></span>
                   <span class="intro-dot"></span>
                   <span class="intro-dot"></span>
               </span>
           </div>
           <div class="intro-tagline" id="introTagline"></div>
       </div>
   </div>

   <div class="login-page" id="loginPage">
       <div class="login-card">
           <div class="login-header">
               <div class="login-logo-small">SouGPT</div>
               <div class="login-subtitle" id="loginSubtitle"></div>
           </div>
           <form id="loginForm" onsubmit="handleLogin(event)">
               <div class="form-group">
                   <label class="form-label" id="usernameLabel"></label>
                   <input type="text" class="form-input" id="usernameInput" required autocomplete="username">
               </div>
               <div class="form-group">
                   <label class="form-label" id="passwordLabel"></label>
                   <input type="password" class="form-input" id="passwordInput" required autocomplete="current-password">
               </div>
               <button type="submit" class="login-btn" id="loginBtn">
                   <span id="loginBtnText"></span>
               </button>
           </form>
           <div class="error-message" id="errorMessage"></div>
       </div>
   </div>

   <div class="app" id="mainApp">
       <header class="header">
           <div class="header-left">
               <div class="logo">SouGPT</div>
               <div class="model-selector" onclick="newChat()">
                   <span>SouGPT Fast</span>
                   <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                       <polyline points="6 9 12 15 18 9"></polyline>
                   </svg>
               </div>
           </div>
           <div class="header-actions">
               <button class="btn-text" onclick="newChat()" id="btnNewChat">
                   <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                       <line x1="12" y1="5" x2="12" y2="19"></line>
                       <line x1="5" y1="12" x2="19" y2="12"></line>
                   </svg>
                   <span id="newChatText">Baru</span>
               </button>
               <button class="btn-icon" onclick="toggleSettings()" title="Settings">
                   <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                       <circle cx="12" cy="12" r="3"></circle>
                       <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
                   </svg>
               </button>
               <button class="btn-icon" onclick="toggleHistory()">
                   <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                       <path d="M12 20v-6M6 20V10M18 20V4"/>
                   </svg>
               </button>
               <div class="user-menu" id="userMenu">
                   <div class="user-avatar" id="userAvatar" onclick="toggleDropdown()">U</div>
                   <div class="dropdown" id="userDropdown">
                       <div class="dropdown-item">
                           <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                               <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                               <circle cx="12" cy="7" r="4"></circle>
                           </svg>
                           <span id="dropdownUsername">User</span>
                       </div>
                       <div class="dropdown-divider"></div>
                       <div class="dropdown-item" onclick="exportChat('markdown')">
                           <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                               <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                               <polyline points="14 2 14 8 20 8"></polyline>
                               <line x1="16" y1="13" x2="8" y2="13"></line>
                               <line x1="16" y1="17" x2="8" y2="17"></line>
                               <polyline points="10 9 9 9 8 9"></polyline>
                           </svg>
                           <span id="exportMdText">Export sebagai Markdown</span>
                       </div>
                       <div class="dropdown-item" onclick="exportChat('pdf')">
                           <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                               <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                               <polyline points="14 2 14 8 20 8"></polyline>
                           </svg>
                           <span id="exportPdfText">Export sebagai PDF</span>
                       </div>
                       <div class="dropdown-divider"></div>
                       <div class="dropdown-item danger" onclick="logout()">
                           <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                               <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                               <polyline points="16 17 21 12 16 7"></polyline>
                               <line x1="21" y1="12" x2="9" y2="12"></line>
                           </svg>
                           <span id="logoutText">Keluar</span>
                       </div>
                   </div>
               </div>
           </div>
       </header>

       <div class="chat-wrapper" id="chatWrapper">
           <div class="landing" id="landing">
               <h1 class="landing-title" id="landingTitle"></h1>
               <div class="suggestions">
                   <div class="suggestion-item" onclick="setInput('Jelaskan konsep quantum computing dalam bahasa sederhana')">
                       Jelaskan konsep quantum computing dalam bahasa sederhana
                   </div>
                   <div class="suggestion-item" onclick="setInput('Buatkan script Python untuk web scraping dengan BeautifulSoup')">
                       Buatkan script Python untuk web scraping dengan BeautifulSoup
                   </div>
                   <div class="suggestion-item" onclick="setInput('Analisis kompleksitas time dan space untuk algoritma merge sort')">
                       Analisis kompleksitas time dan space untuk algoritma merge sort
                   </div>
                   <div class="suggestion-item" onclick="setInput('Cara mengamankan server VPS dari serangan DDoS dan brute force')">
                       Cara mengamankan server VPS dari serangan DDoS dan brute force
                   </div>
               </div>
           </div>

           <div class="messages" id="messages"></div>
           
           <div class="loading-container" id="loadingContainer">
               <div class="loading-pulse"></div>
               <span class="loading-status" id="loadingStatus"></span>
           </div>
       </div>

       <div class="input-container">
           <div class="input-wrapper">
               <textarea 
                   class="chat-input" 
                   id="chatInput" 
                   rows="1"
                   onkeydown="handleKeydown(event)"
                   oninput="autoResize(this)"
               ></textarea>
               <button class="btn-send" id="btnSend" onclick="sendMessage()">
                   <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                       <line x1="22" y1="2" x2="11" y2="13"></line>
                       <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                   </svg>
               </button>
               <button class="btn-stop hidden" id="btnStop" onclick="stopGeneration()">
                   <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor" stroke="none">
                       <rect x="6" y="6" width="12" height="12" rx="2"></rect>
                   </svg>
               </button>
           </div>
       </div>
   </div>

   <div class="overlay" id="overlay" onclick="closePanels()"></div>
   
   <div class="settings-panel" id="settingsPanel">
       <div class="settings-header">
           <span class="settings-title" id="settingsTitle">Pengaturan</span>
           <button class="btn-icon" onclick="toggleSettings()">
               <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                   <line x1="18" y1="6" x2="6" y2="18"></line>
                   <line x1="6" y1="6" x2="18" y2="18"></line>
               </svg>
           </button>
       </div>
       <div class="settings-content">
           <div class="settings-section">
               <div class="settings-section-title" id="displayTitle">Tampilan</div>
               <div class="settings-option">
                   <label class="settings-label" id="themeLabel">Mode</label>
                   <div class="settings-radio-group">
                       <label class="settings-radio">
                           <input type="radio" name="theme" value="dark" onchange="setTheme('dark')">
                           <span id="themeDark">Gelap</span>
                       </label>
                       <label class="settings-radio">
                           <input type="radio" name="theme" value="light" onchange="setTheme('light')">
                           <span id="themeLight">Terang</span>
                       </label>
                       <label class="settings-radio">
                           <input type="radio" name="theme" value="system" onchange="setTheme('system')">
                           <span id="themeSystem">Sistem</span>
                       </label>
                   </div>
               </div>
               <div class="settings-option">
                   <label class="settings-label" id="fontSizeLabel">Ukuran Font</label>
                   <div class="settings-radio-group">
                       <label class="settings-radio">
                           <input type="radio" name="fontsize" value="small" onchange="setFontSize('small')">
                           <span id="fontSmall">Kecil</span>
                       </label>
                       <label class="settings-radio">
                           <input type="radio" name="fontsize" value="medium" onchange="setFontSize('medium')">
                           <span id="fontMedium">Sedang</span>
                       </label>
                       <label class="settings-radio">
                           <input type="radio" name="fontsize" value="large" onchange="setFontSize('large')">
                           <span id="fontLarge">Besar</span>
                       </label>
                   </div>
               </div>
               <div class="settings-option">
                   <label class="settings-label" id="languageLabel">Bahasa</label>
                   <div class="settings-radio-group">
                       <label class="settings-radio">
                           <input type="radio" name="language" value="id" onchange="setLanguage('id')">
                           <span>Indonesia</span>
                       </label>
                       <label class="settings-radio">
                           <input type="radio" name="language" value="en" onchange="setLanguage('en')">
                           <span>English</span>
                       </label>
                   </div>
               </div>
           </div>
           <div class="settings-section">
               <div class="settings-section-title" id="accountTitle">Akun</div>
               <div class="settings-info">
                   <div class="settings-info-row">
                       <span class="settings-info-label" id="usernameInfoLabel">Username</span>
                       <span class="settings-info-value" id="settingsUsername">-</span>
                   </div>
                   <div class="settings-info-row">
                       <span class="settings-info-label" id="memberSinceLabel">Anggota sejak</span>
                       <span class="settings-info-value" id="settingsMemberSince">-</span>
                   </div>
               </div>
           </div>
       </div>
   </div>
   
   <div class="history-panel" id="historyPanel">
       <div class="history-header">
           <span class="history-title" id="historyTitle">Riwayat Chat</span>
           <div class="history-actions">
               <button class="btn-icon" onclick="clearAllHistory()" title="Hapus Semua">
                   <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                       <polyline points="3 6 5 6 21 6"></polyline>
                       <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                   </svg>
               </button>
               <button class="btn-icon" onclick="toggleHistory()">
                   <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                       <line x1="18" y1="6" x2="6" y2="18"></line>
                       <line x1="6" y1="6" x2="18" y2="18"></line>
                   </svg>
               </button>
           </div>
       </div>
       <div class="history-search">
           <div class="history-search-wrapper">
               <input type="text" class="history-search-input" id="historySearch" placeholder="Cari riwayat..." oninput="searchHistory(this.value)">
               <button class="history-search-clear" id="historySearchClear" onclick="clearHistorySearch()">×</button>
           </div>
       </div>
       <div class="history-list" id="historyList"></div>
   </div>

   <script>
       const API_BASE_URL = 'https://sougpt.api.wanzzstoree.my.id';
       const API_CHAT_URL = `${API_BASE_URL}/chat/stream`;
       const API_LOGIN_URL = `${API_BASE_URL}/auth/login`;
       const API_VERIFY_URL = `${API_BASE_URL}/auth/verify`;
       
       const STORAGE_TOKEN_KEY = 'sougpt_token';
       const STORAGE_USERNAME_KEY = 'sougpt_username';
       const STORAGE_HISTORY_KEY = 'chatHistory';
       const STORAGE_PINNED_KEY = 'sougpt_pinned';
       const STORAGE_THEME_KEY = 'sougpt_theme';
       const STORAGE_FONTSIZE_KEY = 'sougpt_fontsize';
       const STORAGE_LANG_KEY = 'sougpt_lang';
       const STORAGE_FIRST_LOGIN_KEY = 'sougpt_first_login';

       const loadingStatuses = [
           "AI Sedang Memproses...",
           "AI Sedang Merakit...",
           "AI Sedang Membuat Referensi...",
           "Menganalisis Pertanyaan...",
           "Menyusun Jawaban...",
           "Mencari Konteks...",
           "Memproses Data...",
           "Merumuskan Respons...",
           "Mengoptimalkan Output...",
           "Memeriksa Akurasi...",
           "Menyempurnakan Kalimat...",
           "Menghubungkan Informasi...",
           "Memvalidasi Jawaban...",
           "Menyaring Referensi...",
           "Mengkalkulasi Respons...",
           "Membangun Struktur...",
           "Mengevaluasi Konteks...",
           "Memperkaya Detail...",
           "Menyelaraskan Informasi...",
           "Menyesuaikan Gaya Bahasa...",
           "Memfinalisasi Output...",
           "Mengecek Konsistensi...",
           "Menyempurnakan Detail...",
           "Memproses Logika...",
           "Menghitung Probabilitas...",
           "Menyaring Noise Data...",
           "Mengintegrasikan Referensi...",
           "Membangun Argumen...",
           "Mengoptimalkan Kalimat...",
           "Menyelesaikan Kalkulasi...",
           "Memeriksa Ulang...",
           "Merapikan Format Output...",
           "Hampir Selesai..."
       ];

       const translations = {
           id: {
               tagline: "Intelligence without limits. Ethics without boundaries.",
               loginSubtitle: "Selamat datang kembali",
               usernameLabel: "Username",
               passwordLabel: "Password",
               loginBtn: "Masuk",
               inputPlaceholder: "Ketik pesan...",
               newChat: "Baru",
               landingTitle: "Apa yang bisa saya bantu?",
               historyTitle: "Riwayat Chat",
               clearAll: "Hapus Semua",
               emptyHistory: "Belum ada riwayat chat",
               noResults: "Tidak ada hasil untuk",
               exportMd: "Export sebagai Markdown",
               exportPdf: "Export sebagai PDF",
               logout: "Keluar",
               settings: "Pengaturan",
               display: "Tampilan",
               theme: "Mode",
               themeDark: "Gelap",
               themeLight: "Terang",
               themeSystem: "Sistem",
               fontSize: "Ukuran Font",
               fontSmall: "Kecil",
               fontMedium: "Sedang",
               fontLarge: "Besar",
               language: "Bahasa",
               account: "Akun",
               username: "Username",
               memberSince: "Anggota sejak",
               searchPlaceholder: "Cari riwayat...",
               stoppedByUser: "Dihentikan oleh pengguna",
               offline: "Koneksi internet terputus",
               serverDown: "Server tidak dapat dijangkau",
               online: "Koneksi kembali normal"
           },
           en: {
               tagline: "Intelligence without limits. Ethics without boundaries.",
               loginSubtitle: "Welcome back",
               usernameLabel: "Username",
               passwordLabel: "Password",
               loginBtn: "Login",
               inputPlaceholder: "Type a message...",
               newChat: "New",
               landingTitle: "What can I help you with?",
               historyTitle: "Chat History",
               clearAll: "Clear All",
               emptyHistory: "No chat history yet",
               noResults: "No results for",
               exportMd: "Export as Markdown",
               exportPdf: "Export as PDF",
               logout: "Logout",
               settings: "Settings",
               display: "Display",
               theme: "Theme",
               themeDark: "Dark",
               themeLight: "Light",
               themeSystem: "System",
               fontSize: "Font Size",
               fontSmall: "Small",
               fontMedium: "Medium",
               fontLarge: "Large",
               language: "Language",
               account: "Account",
               username: "Username",
               memberSince: "Member since",
               searchPlaceholder: "Search history...",
               stoppedByUser: "Stopped by user",
               offline: "Internet connection lost",
               serverDown: "Server unreachable",
               online: "Connection restored"
           }
       };

       let currentToken = null;
       let currentUsername = null;
       let currentChatId = null;
       let isProcessing = false;
       let isStreaming = false;
       let abortController = null;
       let chatHistory = [];
       let pinnedChats = [];
       let loadingStatusInterval = null;
       let currentLang = 'id';
       let currentTheme = 'dark';
       let currentFontSize = 'medium';
       let searchQuery = '';

       const renderer = new marked.Renderer();
       
       renderer.code = function({ text, lang }) {
           const language = lang || 'code';
           const escapedCode = text
               .replace(/&/g, '&amp;')
               .replace(/</g, '&lt;')
               .replace(/>/g, '&gt;');
           const blockId = 'code_' + Math.random().toString(36).substr(2, 9);
           return `<div class="code-block-wrapper"><div class="code-block-header"><span class="code-block-lang">${language}</span><button class="code-block-copy" onclick="copyCode('${blockId}')"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg><span>Salin</span></button></div><pre><code id="${blockId}" class="language-${language}">${escapedCode}</code></pre></div>`;
       };

       marked.setOptions({ renderer: renderer, gfm: true, breaks: true });

       const elements = {
           introScreen: document.getElementById('introScreen'),
           introText: document.getElementById('introText'),
           introCursor: document.getElementById('introCursor'),
           introDots: document.getElementById('introDots'),
           introTagline: document.getElementById('introTagline'),
           loginPage: document.getElementById('loginPage'),
           mainApp: document.getElementById('mainApp'),
           loginForm: document.getElementById('loginForm'),
           usernameInput: document.getElementById('usernameInput'),
           passwordInput: document.getElementById('passwordInput'),
           loginBtn: document.getElementById('loginBtn'),
           loginBtnText: document.getElementById('loginBtnText'),
           errorMessage: document.getElementById('errorMessage'),
           userAvatar: document.getElementById('userAvatar'),
           dropdownUsername: document.getElementById('dropdownUsername'),
           userDropdown: document.getElementById('userDropdown'),
           chatInput: document.getElementById('chatInput'),
           btnSend: document.getElementById('btnSend'),
           btnStop: document.getElementById('btnStop'),
           messages: document.getElementById('messages'),
           landing: document.getElementById('landing'),
           loading: document.getElementById('loadingContainer'),
           loadingStatus: document.getElementById('loadingStatus'),
           chatWrapper: document.getElementById('chatWrapper'),
           historyPanel: document.getElementById('historyPanel'),
           settingsPanel: document.getElementById('settingsPanel'),
           overlay: document.getElementById('overlay'),
           historyList: document.getElementById('historyList'),
           historySearch: document.getElementById('historySearch'),
           historySearchClear: document.getElementById('historySearchClear'),
           customNotif: document.getElementById('customNotif')
       };

       async function playIntro() {
           const text = 'SouGPT';
           const chars = text.split('');
           
           for (let i = 0; i < chars.length; i++) {
               elements.introText.textContent += chars[i];
               await new Promise(r => setTimeout(r, 150));
           }
           
           elements.introCursor.style.display = 'none';
           elements.introDots.style.display = 'inline-flex';
           
           await new Promise(r => setTimeout(r, 800));
           
           elements.introDots.style.display = 'none';
           elements.introCursor.style.display = 'inline-block';
           elements.introTagline.classList.add('show');
           
           await new Promise(r => setTimeout(r, 1500));
           
           elements.introScreen.classList.add('fade-out');
           
           await new Promise(r => setTimeout(r, 800));
           
           elements.introScreen.style.display = 'none';
           checkAuth();
       }

       document.addEventListener('DOMContentLoaded', playIntro);

       function initSettings() {
           const savedTheme = localStorage.getItem(STORAGE_THEME_KEY) || 'dark';
           const savedFontSize = localStorage.getItem(STORAGE_FONTSIZE_KEY) || 'medium';
           const savedLang = localStorage.getItem(STORAGE_LANG_KEY) || 'id';
           
           setTheme(savedTheme, false);
           setFontSize(savedFontSize, false);
           setLanguage(savedLang, false);
       }

       function setTheme(theme, save = true) {
           currentTheme = theme;
           if (save) localStorage.setItem(STORAGE_THEME_KEY, theme);
           
           document.querySelectorAll('input[name="theme"]').forEach(el => {
               el.checked = el.value === theme;
           });
           
           if (theme === 'system') {
               const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
               document.documentElement.setAttribute('data-theme', prefersDark ? 'dark' : 'light');
           } else {
               document.documentElement.setAttribute('data-theme', theme);
           }
       }

       function setFontSize(size, save = true) {
           currentFontSize = size;
           if (save) localStorage.setItem(STORAGE_FONTSIZE_KEY, size);
           
           document.querySelectorAll('input[name="fontsize"]').forEach(el => {
               el.checked = el.value === size;
           });
           
           const sizeClass = size === 'small' ? 'font-small' : size === 'large' ? 'font-large' : 'font-medium';
           document.querySelectorAll('.message-content').forEach(el => {
               el.classList.remove('font-small', 'font-medium', 'font-large');
               el.classList.add(sizeClass);
           });
       }

       function setLanguage(lang, save = true) {
           currentLang = lang;
           if (save) localStorage.setItem(STORAGE_LANG_KEY, lang);
           
           document.querySelectorAll('input[name="language"]').forEach(el => {
               el.checked = el.value === lang;
           });
           
           const t = translations[lang];
           
           elements.introTagline.textContent = t.tagline;
           document.getElementById('loginSubtitle').textContent = t.loginSubtitle;
           document.getElementById('usernameLabel').textContent = t.usernameLabel;
           document.getElementById('passwordLabel').textContent = t.passwordLabel;
           document.getElementById('loginBtnText').textContent = t.loginBtn;
           elements.usernameInput.placeholder = t.usernameLabel;
           elements.passwordInput.placeholder = t.passwordLabel;
           elements.chatInput.placeholder = t.inputPlaceholder;
           document.getElementById('newChatText').textContent = t.newChat;
           document.getElementById('landingTitle').textContent = t.landingTitle;
           document.getElementById('historyTitle').textContent = t.historyTitle;
           document.getElementById('exportMdText').textContent = t.exportMd;
           document.getElementById('exportPdfText').textContent = t.exportPdf;
           document.getElementById('logoutText').textContent = t.logout;
           document.getElementById('settingsTitle').textContent = t.settings;
           document.getElementById('displayTitle').textContent = t.display;
           document.getElementById('themeLabel').textContent = t.theme;
           document.getElementById('themeDark').textContent = t.themeDark;
           document.getElementById('themeLight').textContent = t.themeLight;
           document.getElementById('themeSystem').textContent = t.themeSystem;
           document.getElementById('fontSizeLabel').textContent = t.fontSize;
           document.getElementById('fontSmall').textContent = t.fontSmall;
           document.getElementById('fontMedium').textContent = t.fontMedium;
           document.getElementById('fontLarge').textContent = t.fontLarge;
           document.getElementById('languageLabel').textContent = t.language;
           document.getElementById('accountTitle').textContent = t.account;
           document.getElementById('usernameInfoLabel').textContent = t.username;
           document.getElementById('memberSinceLabel').textContent = t.memberSince;
           elements.historySearch.placeholder = t.searchPlaceholder;
           
           renderHistory();
       }

       async function checkAuth() {
           const token = localStorage.getItem(STORAGE_TOKEN_KEY);
           const username = localStorage.getItem(STORAGE_USERNAME_KEY);

           if (!token || !username) {
               showLogin();
               return;
           }

           try {
               const response = await fetch(API_VERIFY_URL, {
                   method: 'GET',
                   headers: { 'Authorization': `Bearer ${token}` }
               });

               if (!response.ok) throw new Error('Token invalid');

               const data = await response.json();
               
               if (data.valid) {
                   currentToken = token;
                   currentUsername = username;
                   initSettings();
                   loadPinnedChats();
                   showApp();
               } else {
                   throw new Error('Token invalid');
               }
           } catch (err) {
               logout();
           }
       }

       async function handleLogin(e) {
           e.preventDefault();
           
           const username = elements.usernameInput.value.trim();
           const password = elements.passwordInput.value;

           if (!username || !password) return;

           setLoading(true);

           try {
               const response = await fetch(API_LOGIN_URL, {
                   method: 'POST',
                   headers: { 'Content-Type': 'application/json' },
                   body: JSON.stringify({ username, password })
               });

               const data = await response.json();

               if (!response.ok) {
                   throw new Error(data.detail || 'Login gagal');
               }

               currentToken = data.token;
               currentUsername = data.username;

               localStorage.setItem(STORAGE_TOKEN_KEY, currentToken);
               localStorage.setItem(STORAGE_USERNAME_KEY, currentUsername);
               
               const firstLogin = localStorage.getItem(STORAGE_FIRST_LOGIN_KEY);
               if (!firstLogin) {
                   localStorage.setItem(STORAGE_FIRST_LOGIN_KEY, new Date().toISOString());
               }

               showError('');
               initSettings();
               loadPinnedChats();
               showApp();

           } catch (err) {
               showError(err.message);
           } finally {
               setLoading(false);
           }
       }

       function setLoading(loading) {
           elements.loginBtn.disabled = loading;
           elements.loginBtnText.innerHTML = loading 
               ? '<div class="loading-spinner"></div>' 
               : translations[currentLang].loginBtn;
       }

       function showError(message) {
           elements.errorMessage.textContent = message;
           elements.errorMessage.classList.toggle('show', !!message);
       }

       function showLogin() {
           elements.loginPage.classList.add('active');
           elements.mainApp.classList.remove('active');
           elements.usernameInput.value = '';
           elements.passwordInput.value = '';
           showError('');
       }

       function showApp() {
           elements.loginPage.classList.remove('active');
           elements.mainApp.classList.add('active');
           
           elements.userAvatar.textContent = currentUsername.charAt(0).toUpperCase();
           elements.dropdownUsername.textContent = currentUsername;
           document.getElementById('settingsUsername').textContent = currentUsername;
           
           const firstLogin = localStorage.getItem(STORAGE_FIRST_LOGIN_KEY);
           if (firstLogin) {
               const date = new Date(firstLogin);
               document.getElementById('settingsMemberSince').textContent = date.toLocaleDateString(currentLang === 'id' ? 'id-ID' : 'en-US', { day: 'numeric', month: 'long', year: 'numeric' });
           }
           
           loadChatHistory();
           renderHistory();
           elements.chatInput.focus();
       }

       function toggleDropdown() {
           elements.userDropdown.classList.toggle('show');
       }

       function logout() {
           localStorage.removeItem(STORAGE_TOKEN_KEY);
           localStorage.removeItem(STORAGE_USERNAME_KEY);
           currentToken = null;
           currentUsername = null;
           chatHistory = [];
           pinnedChats = [];
           currentChatId = null;
           
           elements.messages.innerHTML = '';
           elements.messages.classList.remove('active');
           elements.landing.style.display = 'flex';
           elements.userDropdown.classList.remove('show');
           
           showLogin();
       }

       function getHistoryKey() {
           return `${STORAGE_HISTORY_KEY}_${currentUsername}`;
       }

       function getPinnedKey() {
           return `${STORAGE_PINNED_KEY}_${currentUsername}`;
       }

       function loadPinnedChats() {
           try {
               const saved = localStorage.getItem(getPinnedKey());
               pinnedChats = saved ? JSON.parse(saved) : [];
           } catch {
               pinnedChats = [];
           }
       }

       function savePinnedChats() {
           localStorage.setItem(getPinnedKey(), JSON.stringify(pinnedChats));
       }

       function togglePinChat(e, id) {
           e.stopPropagation();
           const index = pinnedChats.indexOf(id);
           if (index > -1) {
               pinnedChats.splice(index, 1);
           } else {
               pinnedChats.push(id);
           }
           savePinnedChats();
           renderHistory();
       }

       function loadChatHistory() {
           try {
               const saved = localStorage.getItem(getHistoryKey());
               chatHistory = saved ? JSON.parse(saved) : [];
           } catch {
               chatHistory = [];
           }
       }

       function saveChatHistory() {
           localStorage.setItem(getHistoryKey(), JSON.stringify(chatHistory.slice(0, 50)));
       }

       function generateId() {
           return Date.now().toString(36) + Math.random().toString(36).substr(2, 9);
       }

       function copyCode(blockId) {
           const el = document.getElementById(blockId);
           if (!el) return;
           
           navigator.clipboard.writeText(el.innerText).then(() => {
               const btn = el.closest('.code-block-wrapper').querySelector('.code-block-copy');
               const span = btn.querySelector('span');
               const svg = btn.querySelector('svg');
               
               btn.classList.add('copied');
               span.textContent = 'Tersalin';
               svg.innerHTML = '<polyline points="20 6 9 17 4 12"></polyline>';
               
               setTimeout(() => {
                   btn.classList.remove('copied');
                   span.textContent = 'Salin';
                   svg.innerHTML = '<rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>';
               }, 2000);
           });
       }

       function createUserBubble(text) {
           const row = document.createElement('div');
           row.className = 'message-row user';
           
           const bubble = document.createElement('div');
           bubble.className = 'user-bubble';
           
           const content = document.createElement('div');
           content.className = 'message-content';
           content.textContent = text;
           
           const popup = document.createElement('div');
           popup.className = 'copy-popup';
           popup.innerHTML = `
               <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                   <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                   <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
               </svg>
               Salin teks
           `;
           
           bubble.appendChild(content);
           bubble.appendChild(popup);
           row.appendChild(bubble);
           
           bubble.addEventListener('click', function(e) {
               if (e.target.closest('.copy-popup')) return;
               
               navigator.clipboard.writeText(text).then(() => {
                   bubble.classList.add('show-popup');
                   popup.innerHTML = `
                       <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                           <polyline points="20 6 9 17 4 12"></polyline>
                       </svg>
                       Tersalin
                   `;
                   
                   setTimeout(() => {
                       bubble.classList.remove('show-popup');
                       popup.innerHTML = `
                           <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                               <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                               <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                           </svg>
                           Salin teks
                       `;
                   }, 2000);
               });
           });
           
           return row;
       }

       function createStreamingAIContent() {
           const row = document.createElement('div');
           row.className = 'message-row ai';
           
           const container = document.createElement('div');
           container.className = 'ai-content';
           
           const uniqueId = generateId();
           const thinkBoxId = `thinkBox_${uniqueId}`;
           const thinkContentId = `thinkContent_${uniqueId}`;
           const responseContentId = `responseContent_${uniqueId}`;
           
           const thinkingBox = document.createElement('div');
           thinkingBox.className = 'thinking-box';
           thinkingBox.id = thinkBoxId;
           thinkingBox.innerHTML = `
               <button class="thinking-toggle" onclick="toggleThinking('${uniqueId}')">
                   <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                       <path d="M9 18l6-6-6-6"/>
                   </svg>
                   <span class="thinking-label">Alur Berpikir</span>
                   <span class="thinking-status">
                       Berpikir
                       <span class="typing-indicator" style="margin-left: 4px;">
                           <span class="typing-dot"></span>
                           <span class="typing-dot"></span>
                           <span class="typing-dot"></span>
                       </span>
                   </span>
               </button>
               <div class="thinking-content expanded" id="${thinkContentId}"></div>
           `;
           
           const responseSection = document.createElement('div');
           responseSection.className = 'response-section hidden';
           responseSection.id = `responseSection_${uniqueId}`;
           responseSection.innerHTML = `
               <div class="message-content ${currentFontSize === 'small' ? 'font-small' : currentFontSize === 'large' ? 'font-large' : 'font-medium'}" id="${responseContentId}">
                   <span class="typing-indicator">
                       <span class="typing-dot"></span>
                       <span class="typing-dot"></span>
                       <span class="typing-dot"></span>
                   </span>
               </div>
           `;
           
           container.appendChild(thinkingBox);
           container.appendChild(responseSection);
           row.appendChild(container);
           
           return { 
               row, 
               thinkBoxId, 
               thinkContentId, 
               responseContentId,
               responseSectionId: `responseSection_${uniqueId}`,
               uniqueId 
           };
       }

       function toggleThinking(uniqueId) {
           const thinkBox = document.getElementById(`thinkBox_${uniqueId}`);
           const thinkContent = document.getElementById(`thinkContent_${uniqueId}`);
           const toggle = thinkBox.querySelector('.thinking-toggle');
           
           const isExpanded = thinkContent.classList.contains('expanded');
           
           if (isExpanded) {
               thinkContent.classList.remove('expanded');
               toggle.classList.remove('expanded');
           } else {
               thinkContent.classList.add('expanded');
               toggle.classList.add('expanded');
           }
       }

       function updateThinkingBox(thinkContentId, text) {
           const element = document.getElementById(thinkContentId);
           if (!element) return;
           
           element.textContent = text;
           element.scrollTop = element.scrollHeight;
       }

       function markThinkingDone(thinkBoxId) {
           const thinkBox = document.getElementById(thinkBoxId);
           if (!thinkBox) return;
           
           thinkBox.classList.add('thinking-done');
           
           const status = thinkBox.querySelector('.thinking-status');
           if (status) {
               status.innerHTML = 'Selesai';
           }
           
           const thinkContent = thinkBox.querySelector('.thinking-content');
           const toggle = thinkBox.querySelector('.thinking-toggle');
           if (thinkContent) thinkContent.classList.remove('expanded');
           if (toggle) toggle.classList.remove('expanded');
       }

       function updateResponseSection(responseContentId, text) {
           const element = document.getElementById(responseContentId);
           if (!element) return;
           
           element.innerHTML = marked.parse(text, { breaks: true }) + 
               `<span class="typing-indicator">
                   <span class="typing-dot"></span>
                   <span class="typing-dot"></span>
                   <span class="typing-dot"></span>
               </span>`;
           
           scrollToBottom();
       }

       function finalizeResponse(responseContentId, text) {
           const element = document.getElementById(responseContentId);
           if (!element) return;
           
           element.innerHTML = marked.parse(text, { breaks: true });
           scrollToBottom();
       }

       function setInput(text) {
           elements.chatInput.value = text;
           elements.chatInput.focus();
           autoResize(elements.chatInput);
       }

       function autoResize(el) {
           el.style.height = 'auto';
           el.style.height = Math.min(el.scrollHeight, 200) + 'px';
       }

       function handleKeydown(e) {
           if (e.key === 'Enter' && !e.shiftKey) {
               e.preventDefault();
               sendMessage();
           }
       }

       function scrollToBottom() {
           setTimeout(() => {
               elements.chatWrapper.scrollTop = elements.chatWrapper.scrollHeight;
           }, 10);
       }

       function escapeHtml(text) {
           const div = document.createElement('div');
           div.textContent = text;
           return div.innerHTML;
       }

       function newChat() {
           currentChatId = null;
           elements.messages.innerHTML = '';
           elements.messages.classList.remove('active');
           elements.landing.style.display = 'flex';
           elements.chatInput.value = '';
           autoResize(elements.chatInput);
           elements.chatInput.focus();
           elements.userDropdown.classList.remove('show');
       }

       function startLoadingStatus() {
           let index = 0;
           elements.loadingStatus.textContent = loadingStatuses[0];
           elements.loading.classList.add('active');
           
           loadingStatusInterval = setInterval(() => {
               index = (index + 1) % loadingStatuses.length;
               elements.loadingStatus.textContent = loadingStatuses[index];
           }, 4000);
       }

       function stopLoadingStatus() {
           if (loadingStatusInterval) {
               clearInterval(loadingStatusInterval);
               loadingStatusInterval = null;
           }
           elements.loading.classList.remove('active');
       }

       function stopGeneration() {
           if (abortController) {
               abortController.abort();
           }
       }

       function showStoppedIndicator(row) {
           const aiContent = row.querySelector('.ai-content');
           if (!aiContent) return;
           
           const indicator = document.createElement('div');
           indicator.className = 'stopped-indicator';
           indicator.innerHTML = `
               <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                   <circle cx="12" cy="12" r="10"></circle>
                   <line x1="12" y1="8" x2="12" y2="12"></line>
                   <line x1="12" y1="16" x2="12.01" y2="16"></line>
               </svg>
               ${translations[currentLang].stoppedByUser}
           `;
           aiContent.appendChild(indicator);
       }

       async function sendMessage() {
           const text = elements.chatInput.value.trim();
           if (!text || isProcessing) return;

           if (!currentToken) {
               logout();
               return;
           }

           if (!currentChatId) {
               currentChatId = generateId();
               elements.landing.style.display = 'none';
               elements.messages.classList.add('active');
           }

           elements.chatInput.value = '';
           autoResize(elements.chatInput);

           const userBubble = createUserBubble(text);
           elements.messages.appendChild(userBubble);
           
           const { 
               row: aiRow, 
               thinkBoxId, 
               thinkContentId, 
               responseContentId,
               responseSectionId 
           } = createStreamingAIContent();
           
           elements.messages.appendChild(aiRow);
           scrollToBottom();

           isProcessing = true;
           isStreaming = false;
           elements.btnSend.classList.add('hidden');
           elements.btnStop.classList.remove('hidden');
           startLoadingStatus();

           abortController = new AbortController();
           let lineBuffer = "";
           let thinkText = "";
           let responseText = "";
           let isThinking = true;
           let streamDone = false;
           let firstTokenReceived = false;

           try {
               const response = await fetch(API_CHAT_URL, {
                   method: 'POST',
                   headers: {
                       'Content-Type': 'application/json',
                       'Authorization': `Bearer ${currentToken}`
                   },
                   body: JSON.stringify({
                       message: text,
                       model: 'sougpt:latest',
                       temperature: 0.7,
                       max_tokens: 2048,
                       context_size: 4096
                   }),
                   signal: abortController.signal
               });

               if (response.status === 401) {
                   logout();
                   return;
               }

               if (!response.ok) throw new Error(`HTTP ${response.status}`);

               const reader = response.body.getReader();
               const decoder = new TextDecoder();

               while (true) {
                   const { done, value } = await reader.read();
                   if (done || streamDone) break;

                   if (!firstTokenReceived && value) {
                       firstTokenReceived = true;
                       stopLoadingStatus();
                       isStreaming = true;
                   }

                   lineBuffer += decoder.decode(value, { stream: true });

                   while (lineBuffer.includes("\n")) {
                       const newlineIndex = lineBuffer.indexOf("\n");
                       let line = lineBuffer.slice(0, newlineIndex);
                       lineBuffer = lineBuffer.slice(newlineIndex + 1);
                       
                       if (!line) continue;
                       
                       let isMarker = false;
                       const trimmedLine = line.trim();
                       
                       if (trimmedLine.startsWith('{') && trimmedLine.endsWith('}')) {
                           try {
                               const data = JSON.parse(trimmedLine);
                               
                               if (data.type === "think") {
                                   isMarker = true;
                                   thinkText += data.content || '';
                                   updateThinkingBox(thinkContentId, thinkText);
                               } 
                               else if (data.type === "think_end") {
                                   isMarker = true;
                                   isThinking = false;
                                   markThinkingDone(thinkBoxId);
                                   
                                   const responseSection = document.getElementById(responseSectionId);
                                   if (responseSection) {
                                       responseSection.classList.remove('hidden');
                                   }
                               } 
                               else if (data.type === "end") {
                                   isMarker = true;
                                   streamDone = true;
                                   break;
                               } 
                               else if (data.type === "error") {
                                   isMarker = true;
                                   throw new Error(data.message);
                               }
                           } catch (e) {
                               if (!(e instanceof SyntaxError)) throw e;
                           }
                       }
                       
                       if (!isMarker && !isThinking) {
                           responseText += line + '\n';
                           updateResponseSection(responseContentId, responseText);
                       }
                   }
               }
               
               if (lineBuffer.trim() && !streamDone) {
                   const line = lineBuffer.trim();
                   let isMarker = false;
                   
                   if (line.startsWith('{') && line.endsWith('}')) {
                       try {
                           const data = JSON.parse(line);
                           if (data.type === "end" || data.type === "think_end") {
                               isMarker = true;
                           } else if (data.type === "error") {
                               throw new Error(data.message);
                           }
                       } catch (e) {
                           // Not JSON, treat as text
                       }
                   }
                   
                   if (!isMarker && !isThinking) {
                       responseText += line;
                   }
               }

               responseText = responseText.replace(/\{\s*"type"\s*:\s*"end"[\s\S]*?\}\s*$/g, '');
               responseText = responseText.replace(/\{\s*"type"\s*:\s*"think_end"[\s\S]*?\}\s*$/g, '');
               responseText = responseText.trim();

               finalizeResponse(responseContentId, responseText);
               
               const fullResponse = thinkText ? `<think>${thinkText}</think>\n\n${responseText}` : responseText;
               saveToHistory(text, fullResponse);
               renderHistory();

           } catch (err) {
               if (err.name === 'AbortError') {
                   stopLoadingStatus();
                   showStoppedIndicator(aiRow);
                   
                   if (responseText.trim() || thinkText.trim()) {
                       responseText = responseText.replace(/\{\s*"type"\s*:\s*"end"[\s\S]*?\}\s*$/g, '').trim();
                       const fullResponse = thinkText ? `<think>${thinkText}</think>\n\n${responseText}` : responseText;
                       finalizeResponse(responseContentId, responseText);
                       saveToHistory(text, fullResponse);
                       renderHistory();
                   }
               } else {
                   stopLoadingStatus();
                   aiRow.remove();
                   const errorText = err.message || 'Terjadi kesalahan koneksi.';
                   
                   const errorRow = document.createElement('div');
                   errorRow.className = 'message-row ai';
                   errorRow.innerHTML = `
                       <div class="ai-content">
                           <div class="message-content" style="color: var(--error);">
                               ${escapeHtml(errorText)}
                           </div>
                       </div>
                   `;
                   elements.messages.appendChild(errorRow);
               }
           } finally {
               isProcessing = false;
               isStreaming = false;
               elements.btnSend.classList.remove('hidden');
               elements.btnStop.classList.add('hidden');
               abortController = null;
               scrollToBottom();
           }
       }

       function saveToHistory(userText, aiResponse) {
           const existingIndex = chatHistory.findIndex(h => h.id === currentChatId);
           
           const chatData = {
               id: currentChatId,
               title: userText.length > 50 ? userText.substring(0, 50) + '...' : userText,
               timestamp: new Date().toISOString(),
               messages: existingIndex >= 0 
                   ? [...chatHistory[existingIndex].messages, { user: userText, ai: aiResponse }]
                   : [{ user: userText, ai: aiResponse }]
           };

           if (existingIndex >= 0) {
               chatHistory[existingIndex] = chatData;
           } else {
               chatHistory.unshift(chatData);
           }

           saveChatHistory();
       }

       function searchHistory(query) {
           searchQuery = query.toLowerCase();
           elements.historySearchClear.classList.toggle('show', !!query);
           renderHistory();
       }

       function clearHistorySearch() {
           elements.historySearch.value = '';
           searchQuery = '';
           elements.historySearchClear.classList.remove('show');
           renderHistory();
       }

       function renderHistory() {
           let filteredHistory = chatHistory;
           
           if (searchQuery) {
               filteredHistory = chatHistory.filter(chat => 
                   chat.title.toLowerCase().includes(searchQuery)
               );
           }
           
           const pinnedHistory = filteredHistory.filter(chat => pinnedChats.includes(chat.id));
           const unpinnedHistory = filteredHistory.filter(chat => !pinnedChats.includes(chat.id));
           
           const sortedHistory = [...pinnedHistory, ...unpinnedHistory];
           
           if (sortedHistory.length === 0) {
               if (searchQuery) {
                   elements.historyList.innerHTML = `<div class="no-results">${translations[currentLang].noResults} "${escapeHtml(searchQuery)}"</div>`;
               } else {
                   elements.historyList.innerHTML = `<div class="empty-history">${translations[currentLang].emptyHistory}</div>`;
               }
               return;
           }
           
           elements.historyList.innerHTML = sortedHistory.map(chat => {
               const isPinned = pinnedChats.includes(chat.id);
               return `
               <div class="history-item ${chat.id === currentChatId ? 'active' : ''} ${isPinned ? 'pinned' : ''}" onclick="loadChat('${chat.id}')">
                   <div class="history-text">
                       <div class="history-preview">${escapeHtml(chat.title)}</div>
                       <div class="history-time">${new Date(chat.timestamp).toLocaleDateString(currentLang === 'id' ? 'id-ID' : 'en-US', { day: 'numeric', month: 'short', hour: '2-digit', minute: '2-digit' })}</div>
                   </div>
                   <div class="history-actions-item">
                       <button class="history-pin ${isPinned ? 'pinned' : ''}" onclick="togglePinChat(event, '${chat.id}')" title="${isPinned ? 'Unpin' : 'Pin'}">
                           <svg width="16" height="16" viewBox="0 0 24 24" fill="${isPinned ? 'currentColor' : 'none'}" stroke="currentColor" stroke-width="2">
                               <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
                               <circle cx="12" cy="10" r="3"></circle>
                           </svg>
                       </button>
                       <button class="history-delete" onclick="deleteChat(event, '${chat.id}')">
                           <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                               <polyline points="3 6 5 6 21 6"></polyline>
                               <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                           </svg>
                       </button>
                   </div>
               </div>
           `}).join('');
       }

       function loadChat(id) {
           const chat = chatHistory.find(c => c.id === id);
           if (!chat) return;

           currentChatId = id;
           elements.landing.style.display = 'none';
           elements.messages.classList.add('active');
           elements.messages.innerHTML = '';

           chat.messages.forEach(m => {
               const userBubble = createUserBubble(m.user);
               elements.messages.appendChild(userBubble);
               
               const thinkMatch = m.ai.match(/<think>([\s\S]*?)<\/think>/);
               const thinkContent = thinkMatch ? thinkMatch[1] : '';
               const responseContent = m.ai.replace(/<think>[\s\S]*?<\/think>/, '').trim();
               
               const aiRow = document.createElement('div');
               aiRow.className = 'message-row ai';
               
               let html = '<div class="ai-content">';
               
               if (thinkContent) {
                   html += `
                       <div class="thinking-box thinking-done">
                           <button class="thinking-toggle" onclick="this.nextElementSibling.classList.toggle('expanded'); this.classList.toggle('expanded')">
                               <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                   <path d="M9 18l6-6-6-6"/>
                               </svg>
                               <span class="thinking-label">Alur Berpikir</span>
                               <span class="thinking-status">Selesai</span>
                           </button>
                           <div class="thinking-content">${escapeHtml(thinkContent)}</div>
                       </div>
                   `;
               }
               
               const sizeClass = currentFontSize === 'small' ? 'font-small' : currentFontSize === 'large' ? 'font-large' : 'font-medium';
               html += `<div class="message-content ${sizeClass}">${marked.parse(responseContent, { breaks: true })}</div>`;
               html += '</div>';
               
               aiRow.innerHTML = html;
               elements.messages.appendChild(aiRow);
           });

           closePanels();
           scrollToBottom();
       }

       function deleteChat(e, id) {
           e.stopPropagation();
           chatHistory = chatHistory.filter(c => c.id !== id);
           pinnedChats = pinnedChats.filter(pid => pid !== id);
           saveChatHistory();
           savePinnedChats();
           
           if (currentChatId === id) {
               newChat();
           }
           renderHistory();
       }

       function clearAllHistory() {
           const t = translations[currentLang];
           if (!confirm(currentLang === 'id' ? 'Yakin ingin menghapus semua riwayat chat?' : 'Are you sure you want to clear all chat history?')) return;
           
           chatHistory = [];
           pinnedChats = [];
           saveChatHistory();
           savePinnedChats();
           
           if (currentChatId) {
               newChat();
           }
           renderHistory();
       }

       function exportChat(format) {
           const t = translations[currentLang];
           if (chatHistory.length === 0 && !currentChatId) {
               showNotif(currentLang === 'id' ? 'Tidak ada chat untuk diexport' : 'No chat to export', '#ef4146');
               return;
           }
           
           let chatsToExport = currentChatId 
               ? chatHistory.filter(c => c.id === currentChatId)
               : chatHistory;
           
           if (format === 'markdown') {
               let mdContent = `# SouGPT Chat Export\n\n`;
               mdContent += `Date: ${new Date().toLocaleString()}\n\n`;
               mdContent += `---\n\n`;
               
               chatsToExport.forEach(chat => {
                   mdContent += `## ${chat.title}\n\n`;
                   chat.messages.forEach(m => {
                       mdContent += `### Kamu\n${m.user}\n\n`;
                       const cleanAi = m.ai.replace(/<think>[\s\S]*?<\/think>/g, '').trim();
                       mdContent += `### SouGPT\n${cleanAi}\n\n`;
                   });
                   mdContent += `---\n\n`;
               });
               
               const blob = new Blob([mdContent], { type: 'text/markdown' });
               const url = URL.createObjectURL(blob);
               const a = document.createElement('a');
               a.href = url;
               a.download = `SouGPT-${new Date().toISOString().split('T')[0]}.md`;
               a.click();
               URL.revokeObjectURL(url);
               
               showNotif(currentLang === 'id' ? 'Chat diexport sebagai Markdown' : 'Chat exported as Markdown', '#10a37f');
           } else if (format === 'pdf') {
               window.print();
           }
           
           elements.userDropdown.classList.remove('show');
       }

       function toggleHistory() {
           elements.historyPanel.classList.toggle('open');
           elements.settingsPanel.classList.remove('open');
           elements.overlay.classList.toggle('active');
           elements.userDropdown.classList.remove('show');
       }

       function toggleSettings() {
           elements.settingsPanel.classList.toggle('open');
           elements.historyPanel.classList.remove('open');
           elements.overlay.classList.toggle('active');
           elements.userDropdown.classList.remove('show');
       }

       function closePanels() {
           elements.historyPanel.classList.remove('open');
           elements.settingsPanel.classList.remove('open');
           elements.overlay.classList.remove('active');
       }

       function showNotif(message, color, duration = 3000) {
           const notif = elements.customNotif;
           notif.textContent = message;
           notif.style.background = color;
           notif.classList.add('show');
           setTimeout(() => notif.classList.remove('show'), duration);
       }

       window.addEventListener('offline', () => {
           showNotif(translations[currentLang].offline, '#ef4146', 5000);
       });

       window.addEventListener('online', () => {
           showNotif(translations[currentLang].online, '#10a37f', 3000);
       });

       document.addEventListener('click', (e) => {
           if (!e.target.closest('.user-menu')) {
               elements.userDropdown.classList.remove('show');
           }
           
           if (!e.target.closest('.user-bubble')) {
               document.querySelectorAll('.user-bubble.show-popup').forEach(el => {
                   el.classList.remove('show-popup');
               });
           }
       });

       window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', (e) => {
           if (currentTheme === 'system') {
               document.documentElement.setAttribute('data-theme', e.matches ? 'dark' : 'light');
           }
       });
   </script>
</body>
</html>
